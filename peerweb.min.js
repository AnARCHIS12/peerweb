const LOG_LEVELS={DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4},IS_PRODUCTION="localhost"!==window.location.hostname&&!window.location.hostname.startsWith("127."),CURRENT_LOG_LEVEL=IS_PRODUCTION?LOG_LEVELS.WARN:LOG_LEVELS.DEBUG,PEERWEB_CONFIG={EARLY_PROCESS_THRESHOLD:.95,ESSENTIAL_FILES_THRESHOLD:.8,FILE_PROGRESS_THRESHOLD_REGULAR:.8,FILE_PROGRESS_THRESHOLD_ESSENTIAL:.9,FILE_PROGRESS_THRESHOLD_MEDIA:.7,PROCESSING_TIMEOUT_BASE:15e3,PROCESSING_TIMEOUT_PER_MB:2e3,PROCESSING_TIMEOUT_PER_FILE:500,PROCESSING_TIMEOUT_MIN:15e3,PROCESSING_TIMEOUT_MAX:3e5,SW_WAIT_TIMEOUT_BASE:1e4,SW_WAIT_TIMEOUT_PER_MB:1e3,SW_WAIT_TIMEOUT_MIN:1e4,SW_WAIT_TIMEOUT_MAX:12e4,SCRIPT_LOAD_TIMEOUT:1e4,READY_CHECK_INTERVAL:500,INIT_DELAY:100,INIT_RETRY_DELAY:1e3,FILE_TIMEOUT_BASE:5e3,FILE_TIMEOUT_PER_MB:1e3,FILE_TIMEOUT_MIN:5e3,FILE_TIMEOUT_MAX:6e4,FILE_RETRY_DELAY:2e3,FILE_RETRY_TIMEOUT:15e3,CACHE_MAX_AGE:6048e5,MEDIA_CACHE_SIZE_THRESHOLD:102400,PIECE_SIZE_THRESHOLD_16MB:16777216,PIECE_SIZE_THRESHOLD_256MB:268435456,PIECE_SIZE_THRESHOLD_1GB:1073741824,PIECE_SIZE_16KB:16384,PIECE_SIZE_32KB:32768,PIECE_SIZE_256KB:262144,PIECE_SIZE_1MB:1048576};class ToastNotification{constructor(){this.container=document.getElementById("toast-container"),this.container||(this.container=document.createElement("div"),this.container.id="toast-container",this.container.className="toast-container",document.body.appendChild(this.container)),this.toasts=new Map}show(e,t="info",r="",s=5e3){const i=Date.now()+Math.random(),n=this.createToast(i,e,t,r);return this.container.appendChild(n),this.toasts.set(i,n),s>0&&setTimeout(()=>this.dismiss(i),s),i}createToast(e,t,r,s){const i=document.createElement("div");i.className=`toast toast-${r}`,i.dataset.toastId=String(e);const n=this.getIcon(r),o=s||this.getDefaultTitle(r);i.innerHTML=`\n            <div class="toast-icon">${n}</div>\n            <div class="toast-content">\n                <div class="toast-title">${this.escapeHtml(o)}</div>\n                <div class="toast-message">${this.escapeHtml(t)}</div>\n            </div>\n            <button class="toast-close" aria-label="Close">&times;</button>\n        `;const a=i.querySelector(".toast-close");return a&&a.addEventListener("click",()=>this.dismiss(e)),i}dismiss(e){const t=this.toasts.get(e);t&&(t.classList.add("toast-exit"),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),this.toasts.delete(e)},300))}getIcon(e){const t={success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"};return t[e]||t.info}getDefaultTitle(e){const t={success:"Success",error:"Error",warning:"Warning",info:"Info"};return t[e]||t.info}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}success(e,t="",r=5e3){return this.show(e,"success",t,r)}error(e,t="",r=7e3){return this.show(e,"error",t,r)}warning(e,t="",r=6e3){return this.show(e,"warning",t,r)}info(e,t="",r=5e3){return this.show(e,"info",t,r)}dismissAll(){this.toasts.forEach((e,t)=>this.dismiss(t))}}class PeerWeb{constructor(){this.client=null,this.debug=!1,this.cache=new PeerWebCache,this.toast=new ToastNotification,this.currentSiteData=null,this.currentHash=null,this.serviceWorkerReady=!1,this.clientReady=!1,this.librariesLoaded=!1,this.currentTorrentSize=0,this.currentFileCount=0,this.objectURLs=[],this.timeouts=[],this.processingInProgress=!1,this.processingTimeout=null,this.lastSessionKey="peerweb:lastSession",this.installPromptEvent=null,this.wakeLock=null,this.trackers=["wss://tracker.btorrent.xyz","wss://tracker.openwebtorrent.com","udp://tracker.leechers-paradise.org:6969","udp://tracker.coppersurfer.tk:6969","udp://tracker.opentrackr.org:1337","udp://explodie.org:6969","udp://tracker.empire-js.us:1337"],this.init()}async init(){try{await this.loadRequiredLibraries(),await this.initializeWebTorrent(),await this.registerServiceWorker(),this.setupEventListeners(),this.setupCleanupHandlers(),this.checkURL(),this.updateDebugToggle(),this.updateSessionCard()}catch(e){console.error("PeerWeb initialization failed:",e),this.showError("Failed to initialize PeerWeb: "+e.message)}}async loadRequiredLibraries(){if(this.log("Loading required libraries..."),"undefined"==typeof WebTorrent&&(await this.loadScript("scripts/webtorrent.min.js"),this.log("WebTorrent library loaded")),"undefined"==typeof DOMPurify&&(await this.loadScript("scripts/purify.min.js"),this.log("DOMPurify library loaded")),"undefined"==typeof WebTorrent)throw new Error("Failed to load WebTorrent library");if("undefined"==typeof DOMPurify)throw new Error("Failed to load DOMPurify library");this.librariesLoaded=!0,this.log("All required libraries loaded successfully")}loadScript(e,t=null,r=null){return new Promise((s,i)=>{if(document.querySelector(`script[src="${e}"]`))return void s();const n=document.createElement("script");n.src=e,n.async=!0,t&&(n.integrity=t,this.log(`Adding integrity check: ${t.substring(0,20)}...`)),r&&(n.crossOrigin=r),n.onload=()=>{this.log(`Script loaded: ${e}`),s()},n.onerror=r=>{this.log(`Failed to load script: ${e}`),t&&(this.log("Integrity check may have failed. Trying without integrity..."),n.integrity="",n.crossOrigin=""),i(new Error(`Failed to load script: ${e}`))},document.head.appendChild(n);let o=!1;const a=n.onload;n.onload=(...e)=>{o=!0,a&&a.apply(n,e)},setTimeout(()=>{o||i(new Error(`Script load timeout: ${e}`))},PEERWEB_CONFIG.SCRIPT_LOAD_TIMEOUT)})}async initializeWebTorrent(){if(!this.librariesLoaded)throw new Error("Libraries not loaded yet");return new Promise(e=>{try{this.client=new WebTorrent,this.client.on("error",e=>{this.log("WebTorrent error: "+e.message),console.error("WebTorrent error:",e)}),this.client.on("ready",()=>{this.clientReady=!0,this.log("WebTorrent client ready"),e()}),setTimeout(()=>{this.clientReady||(this.clientReady=!0,this.log("WebTorrent client ready (timeout fallback)"),e())},2e3)}catch(t){this.log("Error initializing WebTorrent: "+t.message),console.error("WebTorrent initialization error:",t),this.client={add:()=>console.error("WebTorrent not available"),seed:()=>console.error("WebTorrent not available")},e()}})}async registerServiceWorker(){if("serviceWorker"in navigator)try{const e=await navigator.serviceWorker.getRegistrations();for(const t of e)t.active&&t.active.scriptURL.includes("peerweb-sw.js")&&(await t.unregister(),this.log("Unregistered existing PeerWeb service worker"));const t=await navigator.serviceWorker.register("./peerweb-sw.js",{scope:"/"});this.log("Service Worker registered successfully"),await navigator.serviceWorker.ready,this.serviceWorkerReady=!0,this.log("Service Worker is ready"),navigator.serviceWorker.addEventListener("message",e=>{this.log(`SW Message: ${e.data.type}`),"RESOURCE_REQUEST"===e.data.type&&this.handleServiceWorkerResourceRequest(e.data.url,e.data.requestId,e.data.filePath)}),t.waiting&&t.waiting.postMessage({type:"SKIP_WAITING"})}catch(e){this.log("Service Worker registration failed: "+e.message),console.error("SW Error:",e)}else this.log("Service Workers not supported")}handleServiceWorkerResourceRequest(e,t,r=null){if(this.log(`SW requesting: ${e} (ID: ${t})`),!this.currentSiteData)return this.log("No site data available"),void this.sendToServiceWorker("RESOURCE_RESPONSE",{requestId:t,url:e,data:null});let s=r;if(!s){s=new URL(e).pathname.split("/").slice(3).join("/"),s&&""!==s||(s="index.html")}this.log(`Looking for file: "${s}"`);const i=this.findFileInSiteData(s);if(i){this.log(`Found file: ${s} (${i.size} bytes, ${i.type})`);const r=Array.from(new Uint8Array(i.content));this.sendToServiceWorker("RESOURCE_RESPONSE",{requestId:t,url:e,data:r,contentType:i.type})}else this.log(`File not found: ${s}`),this.log(`Available files: ${Object.keys(this.currentSiteData).join(", ")}`),this.sendToServiceWorker("RESOURCE_RESPONSE",{requestId:t,url:e,data:null})}async sendToServiceWorker(e,t){navigator.serviceWorker.controller||(this.log("No SW controller, waiting for controller..."),await this.waitForController()),navigator.serviceWorker.controller?(navigator.serviceWorker.controller.postMessage({type:e,...t}),this.log(`Sent to SW: ${e}`)):this.log("ERROR: Still no SW controller available after waiting")}async waitForController(e=null){if(!navigator.serviceWorker.controller)return null===e&&(e=this.calculateSWWaitTimeout(),this.log(`Dynamic SW wait timeout: ${(e/1e3).toFixed(1)} seconds`)),new Promise(t=>{const r=Date.now(),s=()=>{navigator.serviceWorker.controller&&(this.log("SW controller changed and is now available"),navigator.serviceWorker.removeEventListener("controllerchange",s),t())};navigator.serviceWorker.addEventListener("controllerchange",s);const i=()=>{navigator.serviceWorker.controller?(this.log("SW controller is now available"),navigator.serviceWorker.removeEventListener("controllerchange",s),t()):Date.now()-r>e?(this.log("Timeout waiting for SW controller"),navigator.serviceWorker.removeEventListener("controllerchange",s),navigator.serviceWorker.ready.then(e=>{e.waiting?(this.log("Found waiting service worker, attempting to activate..."),e.waiting.postMessage({type:"SKIP_WAITING"}),setTimeout(()=>{navigator.serviceWorker.controller?this.log("Service worker activated successfully"):(this.log("Service worker still not active, reloading page..."),window.location.reload()),t()},1e3)):t()})):setTimeout(i,100)};i()})}calculateProcessingTimeout(e){const t=e.length/1048576,r=e.files.length;let s=PEERWEB_CONFIG.PROCESSING_TIMEOUT_BASE;return s+=t*PEERWEB_CONFIG.PROCESSING_TIMEOUT_PER_MB,s+=r*PEERWEB_CONFIG.PROCESSING_TIMEOUT_PER_FILE,s=Math.max(PEERWEB_CONFIG.PROCESSING_TIMEOUT_MIN,s),s=Math.min(PEERWEB_CONFIG.PROCESSING_TIMEOUT_MAX,s),Math.floor(s)}calculateSWWaitTimeout(){if(0===this.currentTorrentSize)return PEERWEB_CONFIG.SW_WAIT_TIMEOUT_BASE;const e=this.currentTorrentSize/1048576;let t=PEERWEB_CONFIG.SW_WAIT_TIMEOUT_BASE;return t+=e*PEERWEB_CONFIG.SW_WAIT_TIMEOUT_PER_MB,t=Math.max(PEERWEB_CONFIG.SW_WAIT_TIMEOUT_MIN,t),t=Math.min(PEERWEB_CONFIG.SW_WAIT_TIMEOUT_MAX,t),Math.floor(t)}calculateFileTimeout(e){const t=e.length/1048576;let r=PEERWEB_CONFIG.FILE_TIMEOUT_BASE;return r+=t*PEERWEB_CONFIG.FILE_TIMEOUT_PER_MB,r=Math.max(PEERWEB_CONFIG.FILE_TIMEOUT_MIN,r),r=Math.min(PEERWEB_CONFIG.FILE_TIMEOUT_MAX,r),Math.floor(r)}findFileInSiteData(e){if(!this.currentSiteData)return null;this.log(`Searching for: "${e}"`);let t=e;t.startsWith("./")&&(t=t.substring(2)),t.startsWith("/")&&(t=t.substring(1));const r=[e,t];for(const e of r)if(this.currentSiteData[e])return this.log(`Exact match: ${e}`),this.currentSiteData[e];const s=Object.keys(this.currentSiteData);this.log(`All available files: ${s.join(", ")}`);const i=t.split("/").pop();for(const e of s){if(e.split("/").pop()===i)return this.log(`Filename match: ${e}`),this.currentSiteData[e]}for(const e of s)if(e.endsWith(t)||t.endsWith(e))return this.log(`Partial match: ${e}`),this.currentSiteData[e];return null}setupEventListeners(){const e=document.getElementById("debug-toggle");e&&e.addEventListener("click",()=>{this.toggleDebug()});const t=document.getElementById("clear-cache");t&&t.addEventListener("click",()=>{this.clearCache()});const r=document.getElementById("create-torrent");r&&r.addEventListener("click",()=>{this.showTorrentModal()});const s=document.getElementById("load-site");s&&s.addEventListener("click",()=>{const e=document.getElementById("hash-input").value.trim();e&&this.loadSite(e)});const i=document.getElementById("hash-input");i&&i.addEventListener("keypress",e=>{if("Enter"===e.key){const t=e.target.value.trim();t&&this.loadSite(t)}});const n=document.getElementById("back-to-peerweb");n&&n.addEventListener("click",()=>{this.showMainContent()});const o=document.getElementById("close-debug");o&&o.addEventListener("click",()=>{document.getElementById("debug-panel").classList.add("hidden")});const a=document.getElementById("close-modal");a&&a.addEventListener("click",()=>{this.hideTorrentModal()});const l=document.getElementById("file-input");l&&l.addEventListener("change",e=>{this.handleFileSelection(e)});const c=document.getElementById("create-torrent-btn");c&&c.addEventListener("click",()=>{this.createTorrent()});const d=document.getElementById("copy-url");d&&d.addEventListener("click",()=>{const e=document.getElementById("created-url").textContent;navigator.clipboard.writeText(e),this.toast.success("You can now share this link with others!","URL Copied to Clipboard")}),this.setupDragAndDrop(),this.setupQuickUpload(),this.setupSessionControls()}setupDragAndDrop(){const e=document.getElementById("drop-zone"),t=document.getElementById("folder-input"),r=document.getElementById("torrent-input");if(!e)return;["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation()})}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")})}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")})}),e.addEventListener("drop",e=>{const t=e.dataTransfer?Array.from(e.dataTransfer.files):[];this.handleDroppedFiles(t)});const s=document.getElementById("select-folder");s&&t&&s.addEventListener("click",()=>{t.click()});const i=document.getElementById("select-torrent");i&&r&&i.addEventListener("click",()=>{r.click()}),t&&t.addEventListener("change",e=>{const t=e.target,r=t.files?Array.from(t.files):[];this.handleDroppedFiles(r)}),r&&r.addEventListener("change",e=>{const t=e.target,r=t.files?Array.from(t.files):[];this.handleDroppedFiles(r)})}setupQuickUpload(){const e=document.getElementById("open-site");e&&e.addEventListener("click",()=>{const e=document.getElementById("result-hash").textContent,t=`${window.location.origin}${window.location.pathname}?orc=${e}`;window.open(t,"_blank")});const t=document.getElementById("copy-link");t&&t.addEventListener("click",()=>{const e=document.getElementById("result-url").textContent;navigator.clipboard.writeText(e).then(()=>{const e=document.getElementById("copy-link"),t=e.textContent;e.textContent="‚úÖ Copied!",setTimeout(()=>{e.textContent=t},2e3)})}),document.querySelectorAll(".desktop-link").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.target.dataset.os;this.downloadDesktopClient(t)})})}setupSessionControls(){const e=document.getElementById("restore-session");e&&e.addEventListener("click",()=>{const e=this.getLastSession();e?.hash&&this.loadSite(e.hash)});const t=document.getElementById("clear-session");t&&t.addEventListener("click",()=>{this.clearLastSession(),this.toast.info("Session locale effac√©e.","Session")});const r=document.getElementById("install-app");r&&r.addEventListener("click",async()=>{this.installPromptEvent?(this.installPromptEvent.prompt(),await this.installPromptEvent.userChoice,this.installPromptEvent=null,r.classList.add("hidden")):this.toast.info("L'installation n'est pas disponible sur ce navigateur.","Installation")});const s=document.getElementById("enable-continuity");s&&s.addEventListener("click",async()=>{await this.requestWakeLock()}),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.installPromptEvent=e,r&&r.classList.remove("hidden")}),document.addEventListener("visibilitychange",async()=>{this.wakeLock&&"visible"===document.visibilityState&&await this.requestWakeLock(!0)})}handleDroppedFiles(e){if(0===e.length)return;if(this.log(`Dropped ${e.length} files`),!this.clientReady||!this.client)return this.log("WebTorrent client not ready, waiting..."),this.showUploadProgress("WebTorrent client is loading..."),void setTimeout(()=>{this.hideUploadProgress(),this.handleDroppedFiles(e)},1e3);const t=e.filter(e=>e.name.toLowerCase().endsWith(".torrent")&&"application/x-bittorrent"===e.type);if(0!==t.length)return this.log(`Found ${t.length} .torrent files (by MIME type)`),void this.handleTorrentFile(t[0]);{const t=e.filter(e=>e.name.toLowerCase().endsWith(".torrent"));if(t.length>0)return this.log(`Found ${t.length} .torrent files (by extension)`),void this.handleTorrentFile(t[0])}if(e.length>1)return void this.handleFolderUpload(e);const r=e[0];if(!r.name.toLowerCase().endsWith(".html"))return 1===e.length&&r.size<1048576?(this.log("Single small file detected, checking if it's a torrent..."),void this.readFileAsArrayBuffer(r).then(e=>{this.isValidTorrentBuffer(e)?(this.log("File appears to be a torrent despite extension"),this.handleTorrentFile(r)):this.toast.warning("This doesn't appear to be a valid torrent file.\n\nPlease drop:\n‚Ä¢ A website folder (containing HTML files)\n‚Ä¢ A valid .torrent file","Invalid File")}).catch(e=>{this.log(`Error checking file: ${e.message}`),this.toast.warning("Couldn't read the dropped file.\n\nPlease try again with:\n‚Ä¢ A website folder (containing HTML files)\n‚Ä¢ A valid .torrent file","Unable to Process File")})):void this.toast.warning("Please drop:\n‚Ä¢ A website folder (containing HTML files)\n‚Ä¢ A .torrent file to load an existing site","Unsupported File Type");this.handleFolderUpload(e)}async handleTorrentFile(e){if(this.log(`Loading torrent file: ${e.name} (${e.size} bytes)`),this.clientReady&&this.client){this.showUploadProgress("Reading torrent file...");try{const t=await this.readFileAsArrayBuffer(e),r=t instanceof ArrayBuffer?t.byteLength:t.length;if(this.log(`Torrent file read: ${r} bytes`),!this.isValidTorrentBuffer(t))throw new Error("Invalid torrent file format");this.log("Torrent file validation passed, adding to WebTorrent..."),this.addTorrentWithFallback(t,e)}catch(e){this.log(`Error loading torrent: ${e.message}`),console.error("Torrent loading error:",e),this.hideUploadProgress(),e.message.includes("Invalid torrent identifier")?alert("‚ùå Invalid Torrent File\n\nThe file appears to be corrupted or incompatible with WebTorrent.\n\nüîß Troubleshooting:\n‚Ä¢ Try creating a new torrent using the Advanced Torrent Creator\n‚Ä¢ Verify the .torrent file isn't damaged\n‚Ä¢ Make sure it's a BitTorrent v1 torrent (v2 not yet supported)"):e.message.includes("Invalid torrent file format")?alert("‚ùå Not a Valid Torrent\n\nThis file doesn't have a valid torrent file structure.\n\nüîß Troubleshooting:\n‚Ä¢ Ensure the file has a .torrent extension\n‚Ä¢ Try re-downloading the torrent file\n‚Ä¢ Use the PeerWeb Advanced Torrent Creator to generate a new one"):alert("‚ùå Torrent Loading Error\n\n"+e.message+"\n\nüîß Troubleshooting:\n‚Ä¢ Create a new torrent using the Advanced Torrent Creator\n‚Ä¢ Verify your internet connection is stable\n‚Ä¢ Check that the file isn't corrupted\n‚Ä¢ Make sure you have enough available memory")}}else this.toast.info("The WebTorrent client is initializing.\nPlease wait a moment and try again.\n\nTip: You'll see the interface become active when ready.","PeerWeb is Still Loading")}addTorrentWithFallback(e,t){let r=0;const s=(i,n)=>{r++,this.log(`Attempt ${r}: Trying to add torrent using ${n}`);try{this.client.add(i,{announce:this.trackers,path:"/tmp/webtorrent/"},t=>{this.log(`Torrent loaded successfully with ${n}: ${t.infoHash}`),this.log(`Torrent name: ${t.name||"Unknown"}`),this.log(`Number of files: ${t.files.length}`),t.files.forEach((e,t)=>{this.log(`File ${t+1}: ${e.name} (${e.length} bytes)`)}),this.showUploadResult(t.infoHash,e,t),this.hideUploadProgress(),t.files.forEach(e=>e.select()),this.log(`Started downloading ${t.files.length} files`)})}catch(i){if(this.log(`Failed with ${n}: ${i.message}`),!(r<3))throw this.hideUploadProgress(),new Error(`All methods failed. Last error: ${i.message}`);if(1===r){const t=e instanceof ArrayBuffer?new Uint8Array(e):e;s(t,"Uint8Array")}else 2===r&&this.tryBlobMethod(t)}};s(e,"ArrayBuffer")}async tryBlobMethod(e){try{this.log("Trying blob method...");const t=new Blob([e],{type:"application/x-bittorrent"}),r=new FileReader;r.onload=e=>{try{const t=e.target.result,r=new Uint8Array(t);this.log(`Blob method: read ${r.length} bytes`),this.client.add(r,{announce:this.trackers},e=>{this.log(`Torrent loaded successfully with blob method: ${e.infoHash}`),this.showUploadResult(e.infoHash,t,e),this.hideUploadProgress(),e.files.forEach(e=>e.select())})}catch(e){throw this.log(`Blob method failed: ${e.message}`),this.hideUploadProgress(),e}},r.onerror=()=>{throw this.log("Blob method: FileReader error"),this.hideUploadProgress(),new Error("Failed to read file with blob method")},r.readAsArrayBuffer(t)}catch(e){throw this.log(`Blob method error: ${e.message}`),this.hideUploadProgress(),e}}isValidTorrentBuffer(e){try{const t=e instanceof ArrayBuffer?new Uint8Array(e):e;if(this.log(`Validating torrent buffer: ${t.length} bytes`),t.length<50)return this.log("Torrent file too small"),!1;if(100!==t[0])return this.log(`Invalid start byte: 0x${t[0].toString(16)} (expected 0x64 for 'd')`),!1;101!==t[t.length-1]&&this.log(`Invalid end byte: 0x${t[t.length-1].toString(16)} (expected 0x65 for 'e')`);const r=new TextDecoder("utf-8",{fatal:!1}).decode(t);this.log(`Torrent content preview: ${r.substring(0,200)}`);const s=r.includes("announce")||this.findBencodedString(t,"announce"),i=r.includes("info")||this.findBencodedString(t,"info");if(this.log(`Torrent validation - announce: ${s}, info: ${i}`),!s||!i)return this.log("Missing required torrent fields (announce or info)"),!1;const n=r.includes("piece length")||this.findBencodedString(t,"piece length"),o=r.includes("pieces")||this.findBencodedString(t,"pieces");return this.log(`Additional validation - piece length: ${n}, pieces: ${o}`),this.log("Torrent file validation passed"),!0}catch(e){return this.log(`Torrent validation error: ${e.message}`),!1}}findBencodedString(e,t){try{const r=(new TextEncoder).encode(`${t.length}:${t}`);for(let t=0;t<=e.length-r.length;t++){let s=!0;for(let i=0;i<r.length;i++)if(e[t+i]!==r[i]){s=!1;break}if(s)return!0}return!1}catch(e){return!1}}readFileAsArrayBuffer(e){return new Promise((t,r)=>{if(!(e&&e instanceof File))return void r(new Error("Invalid file object"));this.log(`Reading file: ${e.name}, size: ${e.size}, type: ${e.type}`);const s=new FileReader;s.onload=e=>{const s=e.target.result;s&&s.byteLength>0?(this.log(`File read successfully: ${s.byteLength} bytes`),t(s)):r(new Error("File reading returned empty result"))},s.onerror=()=>{const e=s.error||new Error("Unknown FileReader error");this.log(`FileReader error: ${e.message}`),r(new Error("File reading failed: "+e.message))},s.onabort=()=>{this.log("FileReader aborted"),r(new Error("File reading was aborted"))},s.onprogress=e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);this.log(`Reading file: ${t}%`)}};try{s.readAsArrayBuffer(e)}catch(e){this.log(`Failed to start file reading: ${e.message}`),r(new Error("Failed to start file reading: "+e.message))}})}async handleFolderUpload(e){if(this.log(`Processing ${e.length} files for upload`),!this.clientReady||!this.client)return void this.toast.info("Please wait for the WebTorrent client to initialize and try again.","Client Not Ready");if(e.some(e=>(e.webkitRelativePath||e.name).toLowerCase().includes("index.html"))||confirm("No index.html found. Continue anyway? (Site may not load properly)")){this.showUploadProgress("Creating torrent...");try{this.client.seed(e,{announce:this.trackers,name:this.generateTorrentName(e),comment:"Created with PeerWeb - Decentralized Website Hosting",createdBy:"PeerWeb v1.0",private:!1,pieceLength:this.calculateOptimalPieceLength(e)},e=>{this.log(`Torrent created: ${e.infoHash}`),this.log(`Torrent name: ${e.name}`),this.showUploadResult(e.infoHash,e.torrentFile,e),this.hideUploadProgress()})}catch(e){this.log(`Error creating torrent: ${e.message}`),console.error("Seeding error:",e),this.hideUploadProgress(),alert("Error creating torrent: "+e.message)}}}showUploadProgress(e){const t=document.getElementById("upload-progress"),r=document.getElementById("upload-progress-text"),s=document.getElementById("upload-result");t&&t.classList.remove("hidden"),r&&(r.textContent=e),s&&s.classList.add("hidden")}hideUploadProgress(){const e=document.getElementById("upload-progress");e&&e.classList.add("hidden")}showUploadResult(e,t,r){const s=this.sanitizeHash(e),i=`${window.location.origin}${window.location.pathname}?orc=${s}`,n=document.getElementById("result-hash"),o=document.getElementById("result-url"),a=document.getElementById("upload-result");if(n&&(n.textContent=s),o&&(o.textContent=i),t){const e=document.getElementById("download-torrent-file");e&&(e.href&&e.href.startsWith("blob:")&&URL.revokeObjectURL(e.href),e.href=this.createTrackedObjectURL(new Blob([t])),e.download=`website-${s.substring(0,8)}.torrent`,e.style.display="inline-flex")}else{const e=document.getElementById("download-torrent-file");e&&(e.style.display="none")}a&&a.classList.remove("hidden"),this.setLastSession(s,i),r&&this.updateSeedingStats(r)}getLastSession(){try{const e=localStorage.getItem(this.lastSessionKey);return e?JSON.parse(e):null}catch(e){return this.log(`Failed to read last session: ${e.message}`),null}}setLastSession(e,t){try{const r={hash:e,url:t,updatedAt:(new Date).toISOString()};localStorage.setItem(this.lastSessionKey,JSON.stringify(r)),this.updateSessionCard()}catch(e){this.log(`Failed to store last session: ${e.message}`)}}clearLastSession(){try{localStorage.removeItem(this.lastSessionKey),this.updateSessionCard()}catch(e){this.log(`Failed to clear last session: ${e.message}`)}}updateSessionCard(){const e=document.getElementById("session-restore"),t=document.getElementById("session-hash"),r=document.getElementById("session-updated");if(!e||!t||!r)return;const s=this.getLastSession();s&&s.hash?(t.textContent=s.hash,r.textContent=s.updatedAt?`Derni√®re mise √† jour : ${new Date(s.updatedAt).toLocaleString()}`:"",e.classList.remove("hidden")):e.classList.add("hidden")}async requestWakeLock(e=!1){const t=document.getElementById("continuity-status");if(!("wakeLock"in navigator))return t&&(t.textContent="Mode maintien indisponible"),void(e||this.toast.warning("Le mode maintien n‚Äôest pas support√© sur ce navigateur.","Continuit√©"));try{this.wakeLock=await navigator.wakeLock.request("screen"),t&&(t.textContent="Mode maintien actif"),e||this.toast.success("Mode maintien activ√©. Gardez l‚Äôapp ouverte en arri√®re-plan.","Continuit√©"),this.wakeLock.addEventListener("release",()=>{t&&(t.textContent="Mode maintien inactif")})}catch(r){t&&(t.textContent="Activation impossible"),e||this.toast.error("Impossible d‚Äôactiver le mode maintien.","Continuit√©"),this.log(`Wake lock error: ${r.message}`)}}updateSeedingStats(e){e.on("upload",()=>{this.log(`Uploaded: ${this.formatBytes(e.uploaded)} to ${e.numPeers} peers`)})}downloadDesktopClient(e){const t={windows:"Windows",mac:"macOS",linux:"Linux"}[e]||e;this.log(`Desktop client requested for ${t}`),alert(`üöÄ PeerWeb Desktop for ${t} - Coming Soon!\n\nDesktop clients are currently under development.\n\nüí° In the meantime:\n‚Ä¢ Keep this browser tab open to continue hosting\n‚Ä¢ Bookmark this page for easy access\n‚Ä¢ Your site will remain active as long as this tab is open`)}createTrackedObjectURL(e){const t=URL.createObjectURL(e);return this.objectURLs.push(t),this.log(`Created object URL (total: ${this.objectURLs.length})`),t}revokeAllObjectURLs(){this.objectURLs.forEach(e=>{try{URL.revokeObjectURL(e)}catch(e){this.log(`Error revoking URL: ${e.message}`)}}),this.log(`Revoked ${this.objectURLs.length} object URLs`),this.objectURLs=[]}createTimeout(e,t){const r=setTimeout(()=>{this.timeouts=this.timeouts.filter(e=>e!==r),e()},t);return this.timeouts.push(r),this.log(`Created timeout ${r} (total: ${this.timeouts.length})`),r}clearTrackedTimeout(e){e&&(clearTimeout(e),this.timeouts=this.timeouts.filter(t=>t!==e),this.log(`Cleared timeout ${e}`))}clearAllTimeouts(){this.timeouts.forEach(e=>{try{clearTimeout(e)}catch(t){this.log(`Error clearing timeout ${e}: ${t.message}`)}}),this.log(`Cleared ${this.timeouts.length} timeouts`),this.timeouts=[]}setupCleanupHandlers(){window.addEventListener("beforeunload",()=>{this.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.log("Page hidden, performing partial cleanup")})}cleanup(){this.log("Performing cleanup..."),this.clearAllTimeouts(),this.revokeAllObjectURLs(),this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.log("Cleanup complete")}checkURL(){const e=new URLSearchParams(window.location.search),t=e.get("orc");if("true"===e.get("debug")&&(this.debug=!0,this.updateDebugToggle(),this.showDebugPanel()),t){const e=()=>{this.serviceWorkerReady&&this.clientReady&&this.librariesLoaded?this.loadSite(t):setTimeout(e,PEERWEB_CONFIG.READY_CHECK_INTERVAL)};e()}}async loadSite(e){const t=this.sanitizeHash(e);if(this.log(`Loading site with hash: ${t}`),!this.serviceWorkerReady)return this.log("Service worker not ready, waiting..."),void setTimeout(()=>this.loadSite(t),PEERWEB_CONFIG.READY_CHECK_INTERVAL);if(!this.clientReady||!this.client)return this.log("WebTorrent client not ready, waiting..."),void setTimeout(()=>this.loadSite(t),PEERWEB_CONFIG.READY_CHECK_INTERVAL);if(!this.isValidTorrentHash(t))return void alert("‚ùå Invalid Hash Format\n\nThe torrent hash must be a 40-character hexadecimal string.\n\nüîß Format Requirements:\n‚Ä¢ Exactly 40 characters long\n‚Ä¢ Only contains numbers 0-9 and letters A-F\n\nExample: d4f5e6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3");this.currentHash=t,this.setLastSession(t,`${window.location.origin}${window.location.pathname}?orc=${t}`);const r=await this.cache.get(t);if(r)return this.log("Loading from cache..."),void this.displayCachedSite(r,t);this.showLoadingOverlay();const s=`magnet:?xt=urn:btih:${t}&tr=${this.trackers.join("&tr=")}`;this.log(`Magnet URI: ${s}`);try{this.client.add(s,async e=>{this.log(`Torrent added: ${e.name||"Unknown"}`),this.updatePeerStats(e),e.on("download",()=>{this.updateProgress(e),this.updatePeerStats(e),!this.processingInProgress&&this.shouldProcessSiteEarly(e)&&(this.log("Sufficient data downloaded, processing site early..."),this.processingInProgress=!0,this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),this.processTorrentEarly(e,t))}),e.on("done",async()=>{this.log("Download completed (100%)!"),this.processingInProgress||(this.processingInProgress=!0,this.processingTimeout&&(clearTimeout(this.processingTimeout),this.processingTimeout=null),await this.processTorrent(e,t))}),e.on("error",e=>{this.log(`Torrent error: ${e.message}`),this.hideLoadingOverlay(),alert("‚ùå Torrent Load Error\n\n"+e.message+"\n\nüîß Troubleshooting:\n‚Ä¢ Check your internet connection\n‚Ä¢ Verify the hash is correct\n‚Ä¢ Ensure the torrent has active seeders\n‚Ä¢ Try again in a few moments")}),e.files.forEach(e=>e.select()),this.log(`Selected ${e.files.length} files for download`),this.currentTorrentSize=e.length,this.currentFileCount=e.files.length;const r=this.currentTorrentSize/1048576;this.log(`Torrent size: ${this.formatBytes(this.currentTorrentSize)} (${r.toFixed(2)} MB)`),this.log(`File count: ${this.currentFileCount}`);const s=this.findIndexFile(e.files);if(!s)return this.log("No index.html found!"),this.hideLoadingOverlay(),void alert("‚ùå Missing index.html\n\nThis torrent doesn't contain an index.html file.\n\nüîß Requirements:\n‚Ä¢ Every PeerWeb site must have an index.html file\n‚Ä¢ Make sure your website folder includes this file\n‚Ä¢ Re-create the torrent with a proper website structure");this.log(`Found index file: ${s.name}`);const i=this.calculateProcessingTimeout(e);this.log(`Dynamic processing timeout set to: ${(i/1e3).toFixed(1)} seconds`),this.processingTimeout=setTimeout(()=>{!this.processingInProgress&&e.progress>.8&&(this.log("Processing site due to timeout (80%+ downloaded)"),this.processingInProgress=!0,this.processTorrentEarly(e,t))},i)})}catch(e){this.log(`Error adding torrent: ${e.message}`),this.hideLoadingOverlay(),alert("‚ùå Failed to Add Torrent\n\n"+e.message+"\n\nüîß Troubleshooting:\n‚Ä¢ Verify the hash format is correct (40 hex characters)\n‚Ä¢ Check that seeders are available\n‚Ä¢ Ensure your firewall isn't blocking WebRTC connections\n‚Ä¢ Try loading the torrent again")}}sanitizeHash(e){return e&&"string"==typeof e?e.replace(/[^a-fA-F0-9]/g,"").toLowerCase():""}isValidTorrentHash(e){if(!e||"string"!=typeof e)return!1;if(40!==(e=e.trim()).length)return this.log(`Invalid hash length: ${e.length}, expected 40`),!1;return!!/^[a-fA-F0-9]+$/.test(e)||(this.log("Hash contains non-hexadecimal characters"),!1)}shouldProcessSiteEarly(e){if(e.progress>=PEERWEB_CONFIG.EARLY_PROCESS_THRESHOLD)return this.log(`Progress at ${Math.round(100*e.progress)}%, processing early`),!0;return!(!this.findIndexFile(e.files)||!this.hasEssentialFiles(e))&&(this.log("Essential files available, processing early"),!0)}hasEssentialFiles(e){let t=0;const r=e.files.length;e.files.forEach(e=>{e.progress>=.9&&t++});const s=t/r;return this.log(`File availability: ${t}/${r} (${Math.round(100*s)}%)`),s>=PEERWEB_CONFIG.ESSENTIAL_FILES_THRESHOLD}async processTorrentEarly(e,t){this.log("Processing torrent early (before 100% completion)");const r={};let s=0,i=0;const n=e.files.sort((e,t)=>{const r=this.isMediaFile(e.name),s=this.isMediaFile(t.name),i=e.name.toLowerCase().includes("index.html")||e.name.toLowerCase().endsWith(".css")||e.name.toLowerCase().endsWith(".js"),n=t.name.toLowerCase().includes("index.html")||t.name.toLowerCase().endsWith(".css")||t.name.toLowerCase().endsWith(".js");return i&&!n?-1:!i&&n||r&&!s?1:!r&&s?-1:0});this.log(`Processing ${n.length} files (early processing)...`);for(const e of n)try{const t=this.isMediaFile(e.name),i=e.name.toLowerCase().includes("index.html")||e.name.toLowerCase().endsWith(".css");let n=PEERWEB_CONFIG.FILE_PROGRESS_THRESHOLD_REGULAR;if(i?n=PEERWEB_CONFIG.FILE_PROGRESS_THRESHOLD_ESSENTIAL:t&&(n=PEERWEB_CONFIG.FILE_PROGRESS_THRESHOLD_MEDIA),this.log(`Processing file: ${e.name} (${Math.round(100*e.progress)}% complete, need ${Math.round(100*n)}%)`),e.progress<n){if(!t){this.log(`Skipping ${e.name} - only ${Math.round(100*e.progress)}% downloaded`);continue}this.log(`Processing media file early: ${e.name}`)}const o=this.calculateFileTimeout(e);this.log(`File timeout for ${e.name}: ${(o/1e3).toFixed(1)} seconds (${this.formatBytes(e.length)})`);const a=await this.getFileBufferWithTimeout(e,o);r[e.name]={content:a,type:this.getContentType(e.name),isText:this.isTextFile(e.name),isMedia:t,size:a.length},s++,this.log(`Processed ${e.name} (${a.length} bytes, ${r[e.name].type})`)}catch(t){if(i++,this.log(`Failed to process file ${e.name}: ${t.message}`),e.name.toLowerCase().includes("index.html"))try{this.log(`Retrying critical file: ${e.name}`),await new Promise(e=>setTimeout(e,PEERWEB_CONFIG.FILE_RETRY_DELAY));const t=await this.getFileBufferWithTimeout(e,PEERWEB_CONFIG.FILE_RETRY_TIMEOUT);r[e.name]={content:t,type:this.getContentType(e.name),isText:this.isTextFile(e.name),isMedia:!1,size:t.length},s++,this.log(`Successfully processed ${e.name} on retry`)}catch(t){this.log(`Failed to process critical file ${e.name} even on retry: ${t.message}`)}}if(this.log(`Processing complete: ${s} files processed, ${i} files failed`),0===s)return void this.log("No files were processed successfully, waiting for more download progress...");Object.keys(r).some(e=>e.toLowerCase().includes("index.html"))?(this.log(`Successfully processed ${Object.keys(r).length} files with index.html present`),await this.cache.set(t,r),this.displaySite(r,t),this.hideLoadingOverlay(),this.processingInProgress=!1):this.log("No index.html found in processed files, waiting for more download progress...")}isMediaFile(e){return[".mp4",".webm",".avi",".mov",".wmv",".flv",".mkv",".mp3",".wav",".ogg",".aac",".flac",".m4a",".gif"].some(t=>e.toLowerCase().endsWith(t))}getContentType(e){return{html:"text/html",htm:"text/html",css:"text/css",js:"application/javascript",mjs:"application/javascript",json:"application/json",xml:"application/xml",txt:"text/plain",md:"text/markdown",pdf:"application/pdf",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",svg:"image/svg+xml",webp:"image/webp",ico:"image/x-icon",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",otf:"font/otf",eot:"application/vnd.ms-fontobject",mp4:"video/mp4",webm:"video/webm",avi:"video/avi",mov:"video/quicktime",wmv:"video/x-ms-wmv",flv:"video/x-flv",mkv:"video/x-matroska",mp3:"audio/mpeg",wav:"audio/wav",ogg:"audio/ogg",aac:"audio/aac",flac:"audio/flac",m4a:"audio/mp4"}[e.toLowerCase().split(".").pop()]||"application/octet-stream"}getFileBufferWithTimeout(e,t=5e3){return new Promise((r,s)=>{const i=setTimeout(()=>{s(new Error(`File buffer timeout after ${t}ms`))},t);e.getBuffer((e,t)=>{clearTimeout(i),e?s(e):r(t)})})}findIndexFile(e){return e.find(e=>{const t=e.name.toLowerCase();return"index.html"===t||t.endsWith("/index.html")})}async processTorrent(e,t){const r={},s=e.files;this.log(`Processing ${s.length} files...`);for(const e of s)try{this.log(`Processing file: ${e.name}`);const t=await this.getFileBuffer(e);r[e.name]={content:t,type:this.getContentType(e.name),isText:this.isTextFile(e.name),size:t.length},this.log(`Processed ${e.name} (${t.length} bytes, ${r[e.name].type})`)}catch(t){this.log(`Error processing file ${e.name}: ${t.message}`)}this.log(`Successfully processed ${Object.keys(r).length} files`),this.log(`File list: ${Object.keys(r).join(", ")}`),await this.cache.set(t,r),this.displaySite(r,t),this.hideLoadingOverlay(),this.processingInProgress=!1}async displayCachedSite(e,t){this.displaySite(e,t,!0)}displaySite(e,t,r=!1){this.log(`Displaying site with ${Object.keys(e).length} files`),this.log(`Files: ${Object.keys(e).join(", ")}`),this.currentSiteData=e,this.currentHash=t;const s=Object.keys(e).find(e=>{const t=e.toLowerCase();return"index.html"===t||t.endsWith("/index.html")});if(!s)return void alert("‚ùå No index.html Found\n\nThe site data doesn't contain an index.html file.\n\nüîß This usually means:\n‚Ä¢ The torrent is incomplete or corrupted\n‚Ä¢ The website wasn't structured correctly\n‚Ä¢ The download was interrupted\n\nTry reloading the site or creating a new torrent.");this.log(`Found index file: ${s}`);const i=e[s];let n=(new TextDecoder).decode(i.content);this.log("Processing HTML content..."),n=this.processHtmlForPeerWeb(n,e,s,t),n=this.sanitizeHtml(n),this.log("HTML content processed and sanitized");const o=`${window.location.origin}/peerweb-site/${t}/`;this.log(`Site URL: ${o}`);(async()=>{await this.waitForController(),await this.sendToServiceWorker("SITE_READY",{hash:t,fileCount:Object.keys(e).length,fileList:Object.keys(e)}),setTimeout(()=>{this.showSiteViewer(o,t,r)},PEERWEB_CONFIG.INIT_DELAY)})()}processHtmlForPeerWeb(e,t,r,s){this.log("Processing HTML for PeerWeb...");const i=(new DOMParser).parseFromString(e,"text/html"),n=r.includes("/")?r.substring(0,r.lastIndexOf("/")+1):"";[{selector:"link[href]",attr:"href"},{selector:"script[src]",attr:"src"},{selector:"img[src]",attr:"src"},{selector:"source[src]",attr:"src"},{selector:"source[srcset]",attr:"srcset"},{selector:"img[srcset]",attr:"srcset"},{selector:"video[src]",attr:"src"},{selector:"audio[src]",attr:"src"},{selector:"embed[src]",attr:"src"},{selector:"object[data]",attr:"data"}].forEach(({selector:e,attr:t})=>{const r=i.querySelectorAll(e);this.log(`Processing ${r.length} elements with selector: ${e}`),r.forEach(e=>{const r=e.getAttribute(t);if(r&&this.isInternalResource(r)){const i=this.convertToVirtualUrl(r,n,s);i?(e.setAttribute(t,i),this.log(`Converted internal resource: ${r} -> ${i}`)):this.log(`Could not convert internal resource: ${r}`)}else r&&this.log(`Preserving external resource: ${r}`)})});const o=i.querySelectorAll("a[href]");this.log(`Processing ${o.length} navigation links`),o.forEach(e=>{const t=e.getAttribute("href");if(t&&this.isInternalNavigation(t)){const r=this.convertNavigationToVirtualUrl(t,n,s);r&&(e.setAttribute("href",r),this.log(`Converted internal navigation: ${t} -> ${r}`))}else t&&this.log(`Preserving external link: ${t}`)});return i.querySelectorAll("style").forEach(e=>{const t=e.textContent,r=this.processCssContent(t,n,s);e.textContent=r}),i.documentElement.outerHTML}isInternalResource(e){return!!e&&(!e.startsWith("http://")&&!e.startsWith("https://")&&(!e.startsWith("data:")&&(!e.startsWith("blob:")&&(!e.startsWith("//")&&!(e.includes(":")&&!e.startsWith("./")&&!e.startsWith("../"))))))}isInternalNavigation(e){return!!e&&(!!e.startsWith("#")||!e.startsWith("http://")&&!e.startsWith("https://")&&(!e.startsWith("//")&&(!e.startsWith("mailto:")&&(!e.startsWith("tel:")&&!(e.includes(":")&&!e.startsWith("./")&&!e.startsWith("../"))))))}convertToVirtualUrl(e,t,r){let s=e.split("?")[0].split("#")[0];return s.startsWith("./")&&(s=s.substring(2)),s=s.startsWith("../")?this.resolveParentPath(t,s):s.startsWith("/")?s.substring(1):t+s,`/peerweb-site/${r}/${s}`}convertNavigationToVirtualUrl(e,t,r){return e.startsWith("#")?e:this.convertToVirtualUrl(e,t,r)}processCssContent(e,t,r){return e=(e=e.replace(/@import\s+['"]([^'"]+)['"]/g,(e,s)=>{if(this.isInternalResource(s)){const i=this.convertToVirtualUrl(s,t,r);return i?`@import "${i}"`:e}return e})).replace(/url\(['"]?([^'")\s]+)['"]?\)/g,(e,s)=>{if(this.isInternalResource(s)){const i=this.convertToVirtualUrl(s,t,r);return i?`url("${i}")`:e}return e})}resolveParentPath(e,t){const r=e.split("/").filter(Boolean),s=t.split("/");for(const e of s)".."===e?r.pop():"."!==e&&r.push(e);return r.join("/")}sanitizeHtml(e){return DOMPurify.sanitize(e,{ADD_TAGS:["link","style","script"],ADD_ATTR:["href","src","type","rel","crossorigin","integrity","target","data","srcset"],ALLOW_UNKNOWN_PROTOCOLS:!0})}getFileBuffer(e){return new Promise((t,r)=>{e.getBuffer((e,s)=>{e?r(e):t(s)})})}isTextFile(e){return[".html",".css",".js",".json",".txt",".md",".xml",".svg"].some(t=>e.toLowerCase().endsWith(t))}showSiteViewer(e,t,r){const s=document.getElementById("main-content"),i=document.getElementById("site-viewer"),n=document.getElementById("current-hash"),o=document.getElementById("cache-status"),a=document.getElementById("site-frame");s&&s.classList.add("hidden"),i&&i.classList.remove("hidden"),n&&(n.textContent=`Hash: ${t.substring(0,16)}...`),o&&(o.textContent=r?"üíæ From Cache":"üåê Fresh Download"),a&&(a.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-popups allow-modals"),a.onerror=e=>{this.log("Iframe error: "+e.message)},a.onload=()=>{this.log("Iframe loaded successfully");try{const e=a.contentWindow;if(e&&e.navigator&&e.navigator.serviceWorker){e.navigator.serviceWorker.register;e.navigator.serviceWorker.register=function(){return console.warn("[PeerWeb] Service worker registration blocked in embedded site"),Promise.reject(new Error("Service worker registration is disabled in PeerWeb embedded sites"))},this.log("Service worker registration blocked for embedded site")}}catch(e){this.log(`Could not block service worker (this is usually fine): ${e.message}`)}},a.src=e),this.log(`Site loaded in iframe: ${e}`)}showMainContent(){const e=document.getElementById("site-viewer"),t=document.getElementById("main-content"),r=document.getElementById("site-frame");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden"),r&&(r.src=""),this.revokeAllObjectURLs(),this.currentSiteData=null,this.currentHash=null,this.sendToServiceWorker("SITE_UNLOADED",{}),window.history.pushState({},"",window.location.pathname)}showLoadingOverlay(){const e=document.getElementById("loading-overlay");e&&e.classList.remove("hidden")}hideLoadingOverlay(){const e=document.getElementById("loading-overlay");e&&e.classList.add("hidden")}updateProgress(e){const t=Math.round(100*e.progress),r=document.getElementById("loading-progress-bar"),s=document.getElementById("loading-progress-text");let i=t,n=`Downloading: ${t}%`;if(t>=95&&t<100){const t=e.files.filter(e=>e.progress>=.9).length,r=e.files.length;n=`Processing files: ${t}/${r} ready`,i=r>0?Math.round(t/r*100):100}else 100===t&&(n="Download complete!");if(r&&(r.style.width=`${i}%`),s&&(s.textContent=n),this.debug){const e=document.getElementById("progress-bar"),t=document.getElementById("progress-text");e&&(e.style.width=`${i}%`),t&&(t.textContent=`Progress: ${n}`)}}updatePeerStats(e){const t=document.getElementById("peer-stats"),r=e.files.filter(e=>e.progress>=.9).length,s=e.files.length,i=`Peers: ${e.numPeers} | Files: ${r}/${s} ready | Downloaded: ${this.formatBytes(e.downloaded)} | Speed: ${this.formatBytes(e.downloadSpeed)}/s`;t&&(t.textContent=i),this.log(`Peer stats: ${i}`)}formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}toggleDebug(){this.debug=!this.debug,this.updateDebugToggle(),this.debug?this.showDebugPanel():this.hideDebugPanel()}updateDebugToggle(){const e=document.getElementById("debug-toggle");e&&(e.textContent=this.debug?"üêõ Disable Debug Mode":"üêõ Enable Debug Mode")}showDebugPanel(){const e=document.getElementById("debug-panel");e&&e.classList.remove("hidden")}hideDebugPanel(){const e=document.getElementById("debug-panel");e&&e.classList.add("hidden")}log(e,t=LOG_LEVELS.DEBUG){if(t<CURRENT_LOG_LEVEL)return;const r=["DEBUG","INFO","WARN","ERROR"][t]||"DEBUG",s=`[PeerWeb:${r}]`;switch(t){case LOG_LEVELS.ERROR:console.error(s,e);break;case LOG_LEVELS.WARN:console.warn(s,e);break;case LOG_LEVELS.INFO:console.info(s,e);break;default:console.log(s,e)}if(this.debug){const s=document.getElementById("debug-content");if(s){const i=(new Date).toLocaleTimeString(),n=t>=LOG_LEVELS.ERROR?"error":t>=LOG_LEVELS.WARN?"warn":"";s.innerHTML+=`<div class="${n}">[${i}] [${r}] ${e}</div>`,s.scrollTop=s.scrollHeight}}}showError(e){console.error("[PeerWeb Error]",e),alert("PeerWeb Error: "+e)}async clearCache(){await this.cache.clear(),this.log("Cache cleared"),this.toast.success("All cached sites have been removed.","Cache Cleared Successfully")}showTorrentModal(){const e=document.getElementById("torrent-modal");e&&e.classList.remove("hidden")}hideTorrentModal(){const e=document.getElementById("torrent-modal");e&&e.classList.add("hidden");const t=document.getElementById("file-input"),r=document.getElementById("file-list"),s=document.getElementById("create-torrent-btn"),i=document.getElementById("torrent-result");t&&(t.value=""),r&&(r.innerHTML=""),s&&(s.disabled=!0),i&&i.classList.add("hidden")}handleFileSelection(e){const t=e.target,r=t.files?Array.from(t.files):[],s=document.getElementById("file-list"),i=document.getElementById("create-torrent-btn");s&&(s.innerHTML="<h4>Selected Files:</h4>",r.forEach(e=>{const t=document.createElement("div");t.textContent=e.webkitRelativePath||e.name,s.appendChild(t)})),i&&(i.disabled=0===r.length)}createTorrent(){const e=document.getElementById("file-input");if(!e||!e.files)return void alert("Please select files first!");const t=Array.from(e.files);if(0===t.length)return void alert("Please select files first!");if(!this.clientReady||!this.client)return void alert("WebTorrent client not ready. Please wait a moment and try again.");if(!t.some(e=>(e.webkitRelativePath||e.name).toLowerCase().includes("index.html"))&&!confirm("No index.html found. Continue anyway? (Site may not load properly)"))return;this.log(`Creating torrent with ${t.length} files...`);const r=document.getElementById("create-torrent-btn"),s=r?r.textContent:"";r&&(r.disabled=!0,r.textContent="Creating Torrent...");try{this.client.seed(t,{announce:this.trackers,name:this.generateTorrentName(t),comment:"Created with PeerWeb - Decentralized Website Hosting",createdBy:"PeerWeb v1.0",private:!1,pieceLength:this.calculateOptimalPieceLength(t)},e=>{this.log(`Torrent created successfully: ${e.infoHash}`),this.log(`Torrent name: ${e.name}`),this.log(`Files: ${e.files.length}`),r&&(r.disabled=!1,r.textContent=s),this.showTorrentCreationResult(e)})}catch(e){this.log(`Error creating torrent: ${e.message}`),console.error("Torrent creation error:",e),r&&(r.disabled=!1,r.textContent=s),alert("Error creating torrent: "+e.message)}}generateTorrentName(e){if(1===e.length)return e[0].name.replace(/\.[^/.]+$/,"");const t=e.map(e=>e.webkitRelativePath||e.name);if(t.length>0&&t[0].includes("/")){const e=t[0].split("/")[0];if(t.every(t=>t.startsWith(e)))return e}return`PeerWeb-Site-${Date.now()}`}calculateOptimalPieceLength(e){const t=e.reduce((e,t)=>e+t.size,0);return t<PEERWEB_CONFIG.PIECE_SIZE_THRESHOLD_16MB?PEERWEB_CONFIG.PIECE_SIZE_16KB:t<PEERWEB_CONFIG.PIECE_SIZE_THRESHOLD_256MB?PEERWEB_CONFIG.PIECE_SIZE_32KB:t<PEERWEB_CONFIG.PIECE_SIZE_THRESHOLD_1GB?PEERWEB_CONFIG.PIECE_SIZE_256KB:PEERWEB_CONFIG.PIECE_SIZE_1MB}showTorrentCreationResult(e){const t=document.getElementById("torrent-result"),r=document.getElementById("created-hash"),s=document.getElementById("created-url"),i=document.getElementById("download-torrent"),n=this.sanitizeHash(e.infoHash),o=`${window.location.origin}${window.location.pathname}?orc=${n}`;r&&(r.textContent=n),s&&(s.textContent=o);const a=i;if(a&&e.torrentFile)try{a.href&&a.href.startsWith("blob:")&&URL.revokeObjectURL(a.href);const t=new Blob([e.torrentFile],{type:"application/x-bittorrent"}),r=this.createTrackedObjectURL(t);a.href=r,a.download=`${e.name||"website"}.torrent`,a.style.display="inline-flex";const s=e.torrentFile instanceof ArrayBuffer?e.torrentFile.byteLength:e.torrentFile.length;this.log(`Torrent file created: ${s} bytes`)}catch(e){this.log(`Error creating torrent file download: ${e.message}`),a.style.display="none"}t&&t.classList.remove("hidden")}}class PeerWebCache{constructor(){this.dbName="PeerWebCache",this.version=1,this.storeName="sites",this.maxAge=PEERWEB_CONFIG.CACHE_MAX_AGE}async openDB(){return new Promise((e,t)=>{const r=indexedDB.open(this.dbName,this.version);r.onerror=()=>t(r.error),r.onsuccess=()=>e(r.result),r.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){t.createObjectStore(this.storeName,{keyPath:"hash"}).createIndex("timestamp","timestamp")}}})}async set(e,t){try{const r=await this.openDB(),s=r.transaction([this.storeName],"readwrite").objectStore(this.storeName),i={hash:e,data:t,timestamp:Date.now()};await s.put(i),console.log(`[PeerWebCache] Cached site: ${e}`)}catch(e){console.error("[PeerWebCache] Error caching site:",e)}}async get(e){try{const t=await this.openDB(),r=t.transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((t,s)=>{const i=r.get(e);i.onsuccess=()=>{const r=i.result;r&&Date.now()-r.timestamp<this.maxAge?(console.log(`[PeerWebCache] Cache hit: ${e}`),t(r.data)):(r&&this.delete(e),t(null))},i.onerror=()=>s(i.error)})}catch(e){return console.error("[PeerWebCache] Error retrieving from cache:",e),null}}async delete(e){try{const t=await this.openDB(),r=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);await r.delete(e)}catch(e){console.error("[PeerWebCache] Error deleting from cache:",e)}}async clear(){try{const e=await this.openDB(),t=e.transaction([this.storeName],"readwrite").objectStore(this.storeName);await t.clear(),console.log("[PeerWebCache] Cache cleared")}catch(e){console.error("[PeerWebCache] Error clearing cache:",e)}}}document.addEventListener("DOMContentLoaded",()=>{window.peerWeb=new PeerWeb});